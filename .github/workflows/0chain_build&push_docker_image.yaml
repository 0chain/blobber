name: "0chain Build & Publish Docker Image"

on:
  workflow_dispatch:

env:
  ZCHAIN_BLOBBER_REGISTRY: ${{ secrets.ZCHAIN_BLOBBER_REGISTRY }}
  ZCHAIN_VALIDATOR_REGISTRY: ${{ secrets.ZCHAIN_VALIDATOR_REGISTRY }}
  DOCKER_CLI_EXPERIMENTAL: enabled

jobs:
  blobber:
    runs-on: [self-hosted, docker-builds]
    steps:
      - name: Set docker image tag 
        run: |
          if [[ "${{github.ref}}" == refs/pull/* ]]; then
            tag=${GITHUB_REF/\/merge/}
            echo "TAG=$(echo pr-${tag:10})" >> $GITHUB_ENV
          else
            echo "TAG=$(echo ${GITHUB_REF#refs/*/} | sed 's/\//-/g')" >> $GITHUB_ENV
          fi

          echo "BRANCH=$([ -z '${{ github.event.pull_request.head.sha }}' ] && echo ${GITHUB_REF#refs/*/} || echo $GITHUB_HEAD_REF)" >> $GITHUB_ENV
          echo "SHA=$([ -z '${{ github.event.pull_request.head.sha }}' ] && echo $GITHUB_SHA || echo '${{ github.event.pull_request.head.sha }}')" >> $GITHUB_ENV
          
      - name: Setup go 1.18
        uses: actions/setup-go@v2
        with:
          go-version: '1.18' # The Go version to download (if necessary) and use.

      - name: Clone blobber
        uses: actions/checkout@v1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.ZCHAIN_DOCKERHUB_USERNAME }}
          password: ${{ secrets.ZCHAIN_DOCKERHUB_PASSWORD }}

      - name: Build blobber
        run: |
          SHORT_SHA=$(echo ${{ env.SHA }} | head -c 8)
          export DOCKER_IMAGE_BASE="${ZCHAIN_BLOBBER_REGISTRY}:base"
          export DOCKER_BUILD="buildx build --platform linux/amd64,linux/arm64 --push"
          export DOCKER_IMAGE_BLOBBER="-t ${ZCHAIN_BLOBBER_REGISTRY}:${TAG} -t ${ZCHAIN_BLOBBER_REGISTRY}:${TAG}-${SHORT_SHA}"
              
          ./docker.local/bin/build.base.sh && ./docker.local/bin/build.blobber.sh

  validator:
    runs-on: [self-hosted, docker-builds]
    steps:
      - name: Set docker image tag 
        run: |
          if [[ "${{github.ref}}" == refs/pull/* ]]; then
            tag=${GITHUB_REF/\/merge/}
            echo "TAG=$(echo pr-${tag:10})" >> $GITHUB_ENV
          else
            echo "TAG=$(echo ${GITHUB_REF#refs/*/} | sed 's/\//-/g')" >> $GITHUB_ENV
          fi

          echo "BRANCH=$([ -z '${{ github.event.pull_request.head.sha }}' ] && echo ${GITHUB_REF#refs/*/} || echo $GITHUB_HEAD_REF)" >> $GITHUB_ENV
          echo "SHA=$([ -z '${{ github.event.pull_request.head.sha }}' ] && echo $GITHUB_SHA || echo '${{ github.event.pull_request.head.sha }}')" >> $GITHUB_ENV

      - name: Setup go 1.18
        uses: actions/setup-go@v2
        with:
          go-version: '1.18' # The Go version to download (if necessary) and use.

      - name: Clone blobber
        uses: actions/checkout@v1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.ZCHAIN_DOCKERHUB_USERNAME }}
          password: ${{ secrets.ZCHAIN_DOCKERHUB_PASSWORD }}

      - name: Build validator
        run: |
          SHORT_SHA=$(echo ${{ env.SHA }} | head -c 8)
          export DOCKER_IMAGE_BASE="${ZCHAIN_VALIDATOR_REGISTRY}:base"
          export DOCKER_BUILD="buildx build --platform linux/amd64,linux/arm64 --push"
          export DOCKER_IMAGE_VALIDATOR="-t ${ZCHAIN_VALIDATOR_REGISTRY}:${TAG} -t ${ZCHAIN_VALIDATOR_REGISTRY}:${TAG}-${SHORT_SHA}"
          
          ./docker.local/bin/build.base.sh && ./docker.local/bin/build.validator.sh