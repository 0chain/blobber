name: CICD_Hetzner_Test

on:
  workflow_dispatch:
    inputs:
      latest_tag:
        description: 'Type yes for building latest tag'
        default: 'no'
        required: true
      kube_ns:
        description: 'Type namespace'
        required: true
        
env:
  KUBE_NAMESPACE: ${{ github.event.inputs.kube_ns }}
  KUBE_CONFIGS: KUBE_CONFIG_DATA_$KUBE_NAMESPACE
  KUBE_CONFIG: ${{ secrets[KUBE_CONFIGS] }}

jobs:
  dockerize_blobber:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2

    - name: Get the Version for Tagging
      id: get_version
      run: |
        BRANCH=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g')
        SHORT_SHA=$(echo $GITHUB_SHA | head -c 8)
        echo ::set-output name=BRANCH::${BRANCH}
        echo ::set-output name=VERSION::${BRANCH}-${SHORT_SHA} 
        echo $KUBE_NAMESPACE
        echo $KUBE_CONFIGS
        echo $KUBE_CONFIG
        
    - name: Update Blobber Image to Kubernetes Cluster
      uses: actions-hub/kubectl@master
      with:
        args: get pods -A
      env:
        TAG: ${{ steps.get_version.outputs.VERSION }}
